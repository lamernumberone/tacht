<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Тестування</title>
    <style>
        :root { --blue: #007aff; --red: #ff3b30; --green: #34c759; --bg: #f4f7f6; }
        * { box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); margin: 0; display: flex; justify-content: center; 
            align-items: flex-start; min-height: 100vh; 
            padding-top: 10px; 
            user-select: none; overflow-x: hidden;
        }

        #app { 
            background: white; width: 95%; max-width: 450px; padding: 15px; 
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            text-align: center; position: relative; z-index: 1;
        }

        #auth-screen, #quiz-screen, #final-screen { display: none; }

        #auth-screen h2 { margin: 5px 0 10px 0; font-size: 22px; line-height: 1.2; }

        .btn { 
            width: 100%; padding: 14px; margin: 6px 0; border-radius: 12px; 
            border:2px solid #eee; font-size: 18px; cursor: pointer; transition: background 0.2s;
        }

        .primary { background: var(--blue); color: white; border: none; font-weight: 600; }
        .option { background: #f8f9fa; text-align: left; border: 1px solid #efeff4; }

        .timer-display { font-weight: 700; font-size: 24px; color: var(--red); margin-bottom: 5px; }
        #lock-timer { font-size: 40px; margin-bottom: 15px; }

        #progress { font-size: 14px; color: #8e8e93; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        #fs-lock { 
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: white; z-index: 9999; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center; 
            padding: 20px;
        }

        .penalty-text { color: var(--red); font-weight: 800; font-size: 20px; margin: 10px 0; }
        .stat-box { text-align: left; background: #f8f9fa; padding: 12px; border-radius: 15px; margin-top: 15px; }
        .stat-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; font-size: 20px; }

        #quiz-info-preview {
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            text-align: left; 
            font-size: 20px; 
            border: 2px solid #efeff4;
        }
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .preview-label { color: #8e8e93; }
        .preview-val { color: var(--blue); font-weight: 700; }
    </style>
</head>
<body>

<div id="fs-lock">
    <div id="lock-timer" class="timer-display">00:00</div>
    <h2 style="color:var(--red); font-size: 32px; margin: 0 0 10px 0;">ПОРУШЕННЯ</h2>
    <p style="color: #333; font-size: 16px; margin: 5px 0;">Зафіксовано вихід з тесту</p>
    <div id="penalty-display" class="penalty-text">Штраф</div>
    <button class="btn primary" style="max-width: 250px; margin-top: 20px;" onclick="resumeFS()">ПОВЕРНУТИСЯ</button>
</div>

<div id="app">
    <div id="loading">Завантаження...</div>
    <div id="auth-screen">
        <h2 id="quiz-title">Вхід</h2>
        
        <div id="quiz-info-preview">
            <div class="preview-grid">
                <div><span class="preview-label">Питань:</span> <span id="p-count" class="preview-val"></span></div>
                <div><span class="preview-label">Час:</span> <span id="p-time" class="preview-val"></span> хв.</div>
                <div><span class="preview-label">Макс. бал:</span> <span id="p-max" class="preview-val"></span></div>
                <div><span class="preview-label">Прохідний:</span> <span id="p-pass" class="preview-val"></span></div>
            </div>
            <div style="margin-top: 6px; border-top: 1px solid #eee; padding-top: 6px; text-align: center;">
                <span class="preview-label">Штраф:</span> <b id="p-penalty" style="color:var(--red)"></b>
            </div>
        </div>

        <input type="text" id="username" class="btn" style="text-align:center" placeholder="Прізвище та Ім'я" autocomplete="off">
        <button class="btn primary" onclick="handleAuth()">Почати</button>
    </div>
    <div id="quiz-screen">
        <div id="timer" class="timer-display">00:00</div>
        <div id="progress">Питання 0 / 0</div>
        <h3 id="question-txt" style="margin-bottom: 15px; font-size: 22px;"></h3>
        <div id="options-box"></div>
    </div>
    <div id="final-screen"><div id="final-content"></div></div>
</div>

<script>
    let student = "", quizData = [], currentQ = 0, points = 0, alerts = [], userAnswers = [], endTime = 0, quizId = "";
    let isUnloading = false, isRecovering = false, violationLock = false;
    let penaltyPerViolation = 0, globalMaxScore = 0;

    function enterFS() {
        const e = document.documentElement;
        if (e.requestFullscreen) e.requestFullscreen();
        else if (e.webkitRequestFullscreen) e.webkitRequestFullscreen();
        else if (e.msRequestFullscreen) e.msRequestFullscreen();
    }

    function resumeFS() {
        isRecovering = true;
        violationLock = false;
        enterFS();
        document.getElementById('fs-lock').style.display = 'none';
        setTimeout(() => { isRecovering = false; }, 1500);
    }

    window.onload = async () => {
        try {
            const qRes = await fetch('/api/questions');
            const qData = await qRes.json();
            quizId = qData.quiz_id;
            globalMaxScore = qData.max_score;
            penaltyPerViolation = (qData.max_score * 0.1).toFixed(1);
            
            document.getElementById('quiz-title').innerText = qData.quiz_title;
            document.getElementById('p-count').innerText = qData.questions.length;
            document.getElementById('p-time').innerText = Math.floor(qData.time_limit_seconds / 60);
            document.getElementById('p-max').innerText = qData.max_score;
            document.getElementById('p-pass').innerText = qData.min_pass_score;
            document.getElementById('p-penalty').innerText = `-${penaltyPerViolation} б.`;

            document.getElementById('loading').style.display = 'none';
            const final = localStorage.getItem('final_res_' + quizId);
            if (final) {
                let data = JSON.parse(final);
                if (!data.max_score) data.max_score = globalMaxScore;
                return renderFinalScreen(data);
            }
            const saved = localStorage.getItem('session_' + quizId);
            if (saved) {
                const s = JSON.parse(saved);
                student = s.student; currentQ = s.currentQ; points = s.points;
                userAnswers = s.userAnswers; alerts = s.alerts; endTime = s.endTime; quizData = s.quizData;
                document.getElementById('quiz-screen').style.display = 'block';
                startTimer(); renderQuestion();
            } else {
                document.getElementById('auth-screen').style.display = 'block';
            }
        } catch (e) { document.getElementById('loading').innerText = "Помилка зв'язку"; }
    };

    function logViolation(type) {
        if (!student || isUnloading || isRecovering || violationLock) return;
        violationLock = true;
        alerts.push(`${type}: ${new Date().toLocaleTimeString()}`);
        document.getElementById('penalty-display').innerText = `Штраф: -${penaltyPerViolation} б.`;
        saveSession();
        updateLiveProgress();
        document.getElementById('fs-lock').style.display = 'flex';
    }

    window.addEventListener('beforeunload', () => { isUnloading = true; });
    window.addEventListener('blur', () => logViolation("Фокус"));
    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) logViolation("FS");
    });

    function saveSession() {
        if (!student) return;
        localStorage.setItem('session_' + quizId, JSON.stringify({ student, currentQ, points, userAnswers, alerts, endTime, quizData }));
    }

    async function updateLiveProgress() {
        if (!student || isUnloading) return;
        fetch('/api/update_progress', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                username: student, current_q: currentQ, correct_count: points, 
                total_q: quizData.length, v_count: alerts.length 
            })
        });
    }

    async function handleAuth() {
        student = document.getElementById('username').value.trim();
        if (!student) return alert("Введіть ім'я");
        
        const regRes = await fetch('/api/register', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({username: student}) 
        });
        
        if ((await regRes.json()).status === "forbidden") return alert("Вже зареєстровано");
        
        enterFS();
        const qData = await (await fetch('/api/questions')).json();
        quizData = qData.questions;
        endTime = Date.now() + (qData.time_limit_seconds * 1000);
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'block';
        saveSession(); startTimer(); renderQuestion();
    }

    function startTimer() {
        const tInt = setInterval(() => {
            if (isUnloading) { clearInterval(tInt); return; }
            const diff = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
            const timeStr = `${Math.floor(diff/60)}:${(diff%60).toString().padStart(2,'0')}`;
            document.getElementById('timer').innerText = timeStr;
            document.getElementById('lock-timer').innerText = timeStr;
            if (diff <= 0) { clearInterval(tInt); sendResults(); }
        }, 1000);
    }

    function renderQuestion() {
        if (currentQ >= quizData.length) return sendResults();
        updateLiveProgress();
        const q = quizData[currentQ];
        document.getElementById('progress').innerText = `Питання ${currentQ + 1} / ${quizData.length}`;
        document.getElementById('question-txt').innerText = q.question;
        const box = document.getElementById('options-box'); box.innerHTML = '';
        q.options.forEach((opt, i) => {
            const b = document.createElement('button');
            b.className = 'btn option'; b.innerText = opt;
            b.onclick = () => {
                if (i === q.correct_index) points++;
                userAnswers.push({is_right: i === q.correct_index});
                currentQ++; saveSession(); renderQuestion();
            };
            box.appendChild(b);
        });
    }

    async function sendResults() {
        isUnloading = true; 
        const res = await fetch('/api/save_result', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({username: student, score: points, total: quizData.length, violations: alerts, details: userAnswers}) 
        });
        const f = await res.json();
        const resObj = { 
            student, 
            grade: f.final_grade, 
            max_score: f.max_score || globalMaxScore,
            correct: points, 
            total: quizData.length, 
            violations: alerts.length,
            is_passed: f.is_passed,
            total_penalty: (alerts.length * penaltyPerViolation).toFixed(1)
        };
        localStorage.setItem('final_res_' + quizId, JSON.stringify(resObj));
        localStorage.removeItem('session_' + quizId);
        if (document.fullscreenElement && document.exitFullscreen) document.exitFullscreen().catch(() => {});
        renderFinalScreen(resObj);
    }

    function renderFinalScreen(d) {
        document.getElementById('fs-lock').style.display = 'none';
        const statusText = d.is_passed ? "✅ ТЕСТ СКЛАДЕНО" : "❌ ТЕСТ НЕ СКЛАДЕНО";
        const statusColor = d.is_passed ? "var(--green)" : "var(--red)";
        const gradeColor = d.is_passed ? "var(--green)" : "var(--red)";

        document.getElementById('app').innerHTML = `
            <h2 style="margin:0;">${d.student}</h2>
            <div style="font-size:64px; font-weight:800; margin: 10px 0;">
                <span style="color:${gradeColor}">${d.grade}</span> 
                <span style="color:var(--blue)"> / ${d.max_score}</span>
            </div>
            <div class="stat-box">
                <div class="stat-row"><span>Вірно відповідей:</span><b>${d.correct} / ${d.total}</b></div>
                <div class="stat-row"><span>Порушень:</span><b style="color:var(--red)">${d.violations}</b></div>
                <div class="stat-row"><span>Штрафні бали:</span><b style="color:var(--red)">-${d.total_penalty}</b></div>
            </div>
            <h3 style="color:${statusColor}; margin-top:20px;">${statusText}</h3>`;
    }
</script>
</body>
</html>