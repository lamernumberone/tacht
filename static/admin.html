<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Панель Вчителя — Моніторинг</title>
    <style>
        :root { --red: #ff3b30; --green: #34c759; --blue: #007aff; --bg: #1c1c1e; --text-muted: #8e8e93; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; text-align: center; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: auto; background: #2c2c2e; padding: 30px; border-radius: 24px; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #3a3a3c; border-radius: 12px; overflow: hidden; font-size: 15px; }
        .admin-table th, .admin-table td { padding: 14px 15px; text-align: left; border-bottom: 1px solid #48484a; }
        .admin-table th { background: #48484a; font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
        .controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0; padding: 15px; background: #3a3a3c; border-radius: 15px; }
        .btn { padding: 12px 25px; font-size: 15px; border-radius: 10px; border: none; cursor: pointer; color: white; font-weight: bold; }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .hidden { display: none; }
        select { background: #48484a; color: white; border: 1px solid #555; padding: 10px; border-radius: 8px; outline: none; min-width: 200px; }
        
        #test-info-box { 
            background: rgba(255,255,255,0.05); 
            padding: 25px; 
            border-radius: 15px; 
            margin: 20px auto; 
            max-width: 700px; 
            text-align: left; 
            border: 1px solid #444;
        }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; font-size: 28px; }
        .info-label { color: var(--text-muted); }
        .info-val { font-weight: bold; color: var(--blue); }

        #info-title { margin: 0 0 15px 0; color: var(--blue); font-size: 32px; }

        #qr-display { 
            display: none; 
            border: 2px solid #444; 
            padding: 40px; 
            border-radius: 20px; 
            margin-bottom: 20px;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 60px;
            flex-wrap: wrap;
        }

        #url-text { color: #007aff; font-size: 32px; margin: 10px 0; font-family: monospace; background: rgba(0, 122, 255, 0.1); padding: 15px; border-radius: 10px; display: inline-block; font-weight: bold; }
        #active-test-display { color: var(--blue); font-size: 24px; margin: -10px 0 20px 0; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Моніторинг тесту</h1>
        <div id="active-test-display" style="display:none;"></div>
        
        <div id="setup-area">
            <div style="margin-bottom: 20px;">
                <label>Виберіть файл тесту: </label>
                <select id="test-file-select" onchange="updatePreview()"></select>
            </div>

            <div id="test-info-box" style="display:none;">
                <h3 id="info-title"></h3>
                <div class="info-grid">
                    <div><span class="info-label">Питань:</span> <span id="info-count" class="info-val"></span></div>
                    <div><span class="info-label">Час:</span> <span id="info-time" class="info-val"></span> хв.</div>
                    <div><span class="info-label">Макс. бал:</span> <span id="info-max" class="info-val"></span></div>
                    <div><span class="info-label">Прохідний:</span> <span id="info-pass" class="info-val"></span></div>
                    
                    <div style="grid-column: span 2; text-align: center; margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <span class="info-label">Штраф за вихід:</span> 
                        <span id="info-penalty" class="info-val" style="color:var(--red)"></span>
                    </div>
                </div>
            </div>

            <button class="btn btn-green" onclick="startTest()">ПОЧАТИ ТЕСТ ТА ПОКАЗАТИ QR</button>
        </div>

        <div id="qr-display">
            <img id="qr-img" src="" style="width:280px; border:16px solid white; border-radius:10px;">
            
            <div style="text-align: left;">
                <p style="color: #8e8e93; margin-bottom: 10px; font-size: 20px;">Адреса для підключення учнів:</p>
                <div id="url-text">Завантаження...</div>
                <div style="margin-top: 25px;">
                    <button class="btn btn-red" onclick="resetTest()" style="width: 100%;">НОВИЙ ТЕСТ (ОЧИСТИТИ ВСЕ)</button>
                </div>
            </div>
        </div>

        <div id="monitor" style="display:none;">
            <div class="controls">
                <label><input type="checkbox" id="show-correct" onchange="refresh()"> Вірно</label>
                <label><input type="checkbox" id="show-violations" onchange="refresh()"> Порушення</label>
                <label><input type="checkbox" id="show-scores" onchange="refresh()"> Фінальний бал</label>
            </div>
            <table class="admin-table">
                <thead>
                    <tr><th>№</th><th>Учень</th><th>Прогрес</th><th class="col-correct hidden">Вірно</th><th class="col-violations hidden">Поруш.</th><th>IP</th><th>Статус</th><th class="col-score hidden">Бал</th></tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>
    <script>
        let totalQ = 0, minPassScore = 0, isTestActive = false;

        window.addEventListener('beforeunload', (e) => {
            if (isTestActive) { e.preventDefault(); e.returnValue = ''; }
        });

        window.onload = async () => {
            const res = await fetch('/api/list_tests');
            const data = await res.json();
            const select = document.getElementById('test-file-select');
            select.innerHTML = data.tests.map(f => `<option value="${f}" ${f === data.current ? 'selected' : ''}>${f}</option>`).join('');
            updatePreview();
        };

        async function updatePreview() {
            const file = document.getElementById('test-file-select').value;
            if (!file) return;
            const res = await fetch(`/api/test_info?filename=${file}`);
            const data = await res.json();
            document.getElementById('info-title').innerText = data.title;
            document.getElementById('info-count').innerText = data.count;
            document.getElementById('info-time').innerText = data.time;
            document.getElementById('info-max').innerText = data.max_score;
            document.getElementById('info-pass').innerText = data.min_pass;
            document.getElementById('info-penalty').innerText = `-${(data.max_score * 0.1).toFixed(1)} балів`;
            document.getElementById('test-info-box').style.display = 'block';
        }

        async function startTest() {
            const selectedFile = document.getElementById('test-file-select').value;
            await fetch(`/api/restart?test_file=${selectedFile}`, { method: 'POST' });
            const qrRes = await fetch('/api/get_qr');
            const qrData = await qrRes.json();
            const qData = await (await fetch('/api/questions')).json();
            totalQ = qData.questions.length;
            minPassScore = qData.min_pass_score;
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('active-test-display').innerText = qData.quiz_title;
            document.getElementById('active-test-display').style.display = 'block';
            document.getElementById('qr-img').src = 'data:image/png;base64,' + qrData.qr_base64;
            document.getElementById('url-text').innerText = qrData.url;
            document.getElementById('qr-display').style.display = 'flex'; 
            document.getElementById('monitor').style.display = 'block';
            isTestActive = true;
            setInterval(refresh, 5000); refresh();
        }

        async function resetTest() {
            if (!confirm("УВАГА! Це створить нову базу даних. Продовжити?")) return;
            isTestActive = false; window.location.reload();
        }

        async function refresh() {
            try {
                const res = await (await fetch('/api/active_users')).json();
                const c = document.getElementById('show-correct').checked;
                const v = document.getElementById('show-violations').checked;
                const s = document.getElementById('show-scores').checked;
                document.querySelectorAll('.col-correct').forEach(e => e.classList.toggle('hidden', !c));
                document.querySelectorAll('.col-violations').forEach(e => e.classList.toggle('hidden', !v));
                document.querySelectorAll('.col-score').forEach(e => e.classList.toggle('hidden', !s));
                document.getElementById('user-list').innerHTML = res.users.map((u, i) => {
                    let passed = u.score >= minPassScore;
                    return `<tr>
                        <td>${i + 1}</td>
                        <td style="font-weight:600;">${u.name}</td>
                        <td>${u.finished ? totalQ : u.progress} / ${totalQ}</td>
                        <td class="col-correct ${c ? '' : 'hidden'}">${u.correct}</td>
                        <td class="col-violations ${v ? '' : 'hidden'}">${u.v_count}</td>
                        <td>${u.ip}</td>
                        <td style="color:${u.finished ? (passed ? 'var(--green)' : 'var(--red)') : 'var(--blue)'}; font-weight:bold;">${u.finished ? (passed ? 'СКЛАДЕНО' : 'НЕ СКЛАДЕНО') : 'АКТИВНИЙ'}</td>
                        <td class="col-score ${s ? '' : 'hidden'}">${u.score}</td>
                    </tr>`;
                }).join('');
            } catch(e) {}
        }
    </script>
</body>
</html>