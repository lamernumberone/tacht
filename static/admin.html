<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Панель Вчителя — Моніторинг</title>
    <style>
        :root { --red: #ff3b30; --green: #34c759; --blue: #007aff; --bg: #1c1c1e; --text-muted: #8e8e93; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; text-align: center; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: auto; background: #2c2c2e; padding: 30px; border-radius: 24px; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #3a3a3c; border-radius: 12px; overflow: hidden; font-size: 15px; }
        .admin-table th, .admin-table td { padding: 14px 15px; text-align: left; border-bottom: 1px solid #48484a; }
        .admin-table th { background: #48484a; font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
        .controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0; padding: 15px; background: #3a3a3c; border-radius: 15px; }
        .btn { padding: 12px 25px; font-size: 15px; border-radius: 10px; border: none; cursor: pointer; color: white; font-weight: bold; }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .hidden { display: none; }
        select { background: #48484a; color: white; border: 1px solid #555; padding: 10px; border-radius: 8px; outline: none; }
        
        #url-text { 
            color: #007aff; 
            font-size: 28px; 
            margin: 10px 0; 
            font-family: monospace; 
            background: rgba(0, 122, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Моніторинг тесту</h1>
        
        <div id="setup-area">
            <div style="margin-bottom: 20px;">
                <label>Виберіть файл тесту: </label>
                <select id="test-file-select"></select>
            </div>
            <button class="btn btn-green" onclick="startTest()">ПОЧАТИ ТЕСТ ТА ПОКАЗАТИ QR</button>
        </div>

        <div id="qr-display" style="display:none; border: 2px solid #444; padding: 20px; border-radius: 20px; margin-bottom: 20px;">
            <img id="qr-img" src="" style="width:320px; border:16px solid white; border-radius:10px; margin:15px;">
            <div style="margin-top: 10px;">
                <p style="color: #8e8e93; margin-bottom: 5px;">Адреса для підключення:</p>
                <div id="url-text">Завантаження...</div>
            </div>
        </div>

        <div id="monitor" style="display:none;">
            <div class="controls">
                <label><input type="checkbox" id="show-correct" onchange="refresh()"> Вірно</label>
                <label><input type="checkbox" id="show-violations" onchange="refresh()"> Порушення</label>
                <label><input type="checkbox" id="show-scores" onchange="refresh()"> Фінальний бал</label>
                <button class="btn btn-red" onclick="resetTest()">НОВИЙ ТЕСТ (ОЧИСТИТИ ВСЕ)</button>
            </div>
            <table class="admin-table">
                <thead>
                    <tr><th>№</th><th>Учень</th><th>Прогрес</th><th class="col-correct hidden">Вірно</th><th class="col-violations hidden">Поруш.</th><th>IP</th><th>Статус</th><th class="col-score hidden">Бал</th></tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>
    <script>
        let totalQ = 0;
        let minPassScore = 0;

        window.onload = async () => {
            const res = await fetch('/api/list_tests');
            const data = await res.json();
            const select = document.getElementById('test-file-select');
            select.innerHTML = data.tests.map(f => `<option value="${f}" ${f === data.current ? 'selected' : ''}>${f}</option>`).join('');
        };

        async function startTest() {
            const selectedFile = document.getElementById('test-file-select').value;
            await fetch(`/api/restart?test_file=${selectedFile}`, { method: 'POST' });
            
            const qrRes = await fetch('/api/get_qr');
            const qrData = await qrRes.json();
            
            const qData = await (await fetch('/api/questions')).json();
            totalQ = qData.questions.length;
            minPassScore = qData.min_pass_score;
            
            document.getElementById('setup-area').style.display = 'none';
            
            document.getElementById('qr-img').src = 'data:image/png;base64,' + qrData.qr_base64;
            document.getElementById('url-text').innerText = qrData.url;
            
            document.getElementById('qr-display').style.display = 'block';
            document.getElementById('monitor').style.display = 'block';
            
            // Збільшено інтервал до 5000мс для зменшення навантаження
            setInterval(refresh, 5000); 
            refresh();
        }

        async function resetTest() {
            if (!confirm("УВАГА! Це створить нову порожню базу даних. Продовжити?")) return;
            window.location.reload();
        }

        async function refresh() {
            try {
                const res = await (await fetch('/api/active_users')).json();
                const c = document.getElementById('show-correct').checked;
                const v = document.getElementById('show-violations').checked;
                const s = document.getElementById('show-scores').checked;
                
                document.querySelectorAll('.col-correct').forEach(e => e.classList.toggle('hidden', !c));
                document.querySelectorAll('.col-violations').forEach(e => e.classList.toggle('hidden', !v));
                document.querySelectorAll('.col-score').forEach(e => e.classList.toggle('hidden', !s));
                
                document.getElementById('user-list').innerHTML = res.users.map((u, i) => {
                    let statusText = 'АКТИВНИЙ';
                    let statusColor = 'var(--green)';
                    if (u.finished) {
                        const passed = u.score >= minPassScore;
                        statusText = passed ? 'СКЛАДЕНО' : 'НЕ СКЛАДЕНО';
                        statusColor = passed ? 'var(--green)' : 'var(--red)';
                    }
                    return `
                    <tr>
                        <td style="color:var(--text-muted)">${i + 1}</td>
                        <td style="font-weight:600;">${u.name}</td>
                        <td style="color:var(--blue)">${u.finished ? totalQ : u.progress} / ${totalQ}</td>
                        <td class="col-correct ${c ? '' : 'hidden'}" style="color:var(--blue)">${u.correct} / ${totalQ}</td>
                        <td class="col-violations ${v ? '' : 'hidden'}" style="color:orange;">${u.v_count}</td>
                        <td style="color:var(--text-muted)">${u.ip}</td>
                        <td style="color:${statusColor}; font-weight:bold; font-size:11px;">${statusText}</td>
                        <td class="col-score ${s ? '' : 'hidden'}" style="color:var(--blue); font-weight:bold;">${u.score}</td>
                    </tr>`;
                }).join('');
            } catch(e) {}
        }
    </script>
</body>
</html>